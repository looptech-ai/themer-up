name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BATS_VERSION: "1.10.0"

jobs:
  # ============================================
  # Stage 1: Static Analysis (runs in parallel)
  # ============================================

  shellcheck:
    name: ShellCheck Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          format: gcc
          severity: warning

  validate-json:
    name: Validate JSON Configs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate theme JSON files
        run: |
          echo "Validating JSON files..."
          for file in themes/*/iterm2.json themes/*/vscode.json themes/*/theme.json; do
            if [[ -f "$file" ]]; then
              echo "Checking $file"
              python3 -m json.tool "$file" > /dev/null || exit 1
            fi
          done
          echo "All JSON files valid!"

  validate-yaml:
    name: Validate YAML Configs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install yamllint
        run: pip install yamllint

      - name: Validate YAML files
        run: |
          for file in themes/*/*.yaml; do
            if [[ -f "$file" ]]; then
              echo "Checking $file"
              yamllint -d relaxed "$file" || exit 1
            fi
          done
          echo "All YAML files valid!"

  # ============================================
  # Stage 2: Unit Tests (parallel by script)
  # ============================================

  unit-tests:
    name: Unit Tests
    runs-on: macos-latest
    needs: [shellcheck]  # Only run if linting passes
    strategy:
      fail-fast: false
      matrix:
        test-file:
          - backup
          - restore
          - apply
    steps:
      - uses: actions/checkout@v4

      - name: Cache BATS installation
        uses: actions/cache@v4
        id: bats-cache
        with:
          path: ~/.local/bats
          key: bats-${{ env.BATS_VERSION }}-macos

      - name: Install BATS
        if: steps.bats-cache.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/bats-core/bats-core.git
          cd bats-core
          ./install.sh ~/.local/bats

      - name: Add BATS to PATH
        run: echo "$HOME/.local/bats/bin" >> "$GITHUB_PATH"

      - name: Run unit tests
        env:
          TEST_FILE: ${{ matrix.test-file }}
        run: |
          bats "tests/unit/${TEST_FILE}.bats" --tap

  # ============================================
  # Stage 3: Integration Tests (after unit tests)
  # ============================================

  integration-tests:
    name: Integration Tests
    runs-on: macos-latest
    needs: [unit-tests]  # Only run if unit tests pass
    steps:
      - uses: actions/checkout@v4

      - name: Cache BATS installation
        uses: actions/cache@v4
        id: bats-cache
        with:
          path: ~/.local/bats
          key: bats-${{ env.BATS_VERSION }}-macos

      - name: Install BATS
        if: steps.bats-cache.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/bats-core/bats-core.git
          cd bats-core
          ./install.sh ~/.local/bats

      - name: Add BATS to PATH
        run: echo "$HOME/.local/bats/bin" >> "$GITHUB_PATH"

      - name: Run integration tests
        run: |
          bats tests/integration/*.bats --tap

  # ============================================
  # Stage 4: Theme Validation (parallel check)
  # ============================================

  theme-validation:
    name: Validate Themes
    runs-on: ubuntu-latest
    needs: [validate-json, validate-yaml]
    steps:
      - uses: actions/checkout@v4

      - name: Check theme completeness
        run: |
          REQUIRED_FILES=("iterm2.json" "p10k.zsh" "mprocs.yaml" "theme.json")

          for theme_dir in themes/*/; do
            theme_name=$(basename "$theme_dir")
            echo "Validating theme: $theme_name"

            for file in "${REQUIRED_FILES[@]}"; do
              if [[ ! -f "${theme_dir}${file}" ]]; then
                echo "ERROR: Missing $file in $theme_name"
                exit 1
              fi
            done

            echo "  All required files present"
          done

  # ============================================
  # Final: Summary Job
  # ============================================

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [shellcheck, validate-json, validate-yaml, unit-tests, integration-tests, theme-validation]
    if: always()
    steps:
      - name: Check all jobs passed
        env:
          SHELLCHECK_RESULT: ${{ needs.shellcheck.result }}
          JSON_RESULT: ${{ needs.validate-json.result }}
          YAML_RESULT: ${{ needs.validate-yaml.result }}
          UNIT_RESULT: ${{ needs.unit-tests.result }}
          INTEGRATION_RESULT: ${{ needs.integration-tests.result }}
          THEME_RESULT: ${{ needs.theme-validation.result }}
        run: |
          if [[ "$SHELLCHECK_RESULT" != "success" ]] || \
             [[ "$JSON_RESULT" != "success" ]] || \
             [[ "$YAML_RESULT" != "success" ]] || \
             [[ "$UNIT_RESULT" != "success" ]] || \
             [[ "$INTEGRATION_RESULT" != "success" ]] || \
             [[ "$THEME_RESULT" != "success" ]]; then
            echo "One or more jobs failed"
            exit 1
          fi
          echo "All CI checks passed!"
